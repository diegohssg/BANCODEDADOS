CREATE TABLE TIPO_CONTA (
    id_tipo_conta INT PRIMARY KEY AUTO_INCREMENT,
    descricao VARCHAR(20) NOT NULL UNIQUE
);

CREATE TABLE TIPO_TRANSACAO (
    id_tipo_transacao INT PRIMARY KEY AUTO_INCREMENT,
    descricao VARCHAR(20) NOT NULL UNIQUE
);

-- 2. Entidades principais
CREATE TABLE CLIENTE (
    id_cliente INT PRIMARY KEY AUTO_INCREMENT,
    nome VARCHAR(100) NOT NULL,
    cpf VARCHAR(14) NOT NULL UNIQUE,
    data_nascimento DATE NOT NULL,
    endereco VARCHAR(200),
    telefone VARCHAR(20),
    email VARCHAR(100) UNIQUE
);

CREATE TABLE AGENCIA (
    id_agencia INT PRIMARY KEY AUTO_INCREMENT,
    codigo_agencia VARCHAR(10) NOT NULL UNIQUE,
    nome VARCHAR(100) NOT NULL,
    cidade VARCHAR(80) NOT NULL
);

CREATE TABLE CONTA (
    id_conta INT PRIMARY KEY AUTO_INCREMENT,
    numero_conta VARCHAR(20) NOT NULL,
    data_abertura DATE NOT NULL,
    saldo_atual DECIMAL(15,2) DEFAULT 0.00,
    status_conta ENUM('ativa', 'bloqueada', 'encerrada') DEFAULT 'ativa',
    id_cliente INT NOT NULL,
    id_tipo_conta INT NOT NULL,
    id_agencia INT,
    CONSTRAINT UNIQUE (numero_conta, id_agencia),
    FOREIGN KEY (id_cliente) REFERENCES CLIENTE(id_cliente),
    FOREIGN KEY (id_tipo_conta) REFERENCES TIPO_CONTA(id_tipo_conta),
    FOREIGN KEY (id_agencia) REFERENCES AGENCIA(id_agencia)
);

CREATE TABLE TRANSACAO (
    id_transacao INT PRIMARY KEY AUTO_INCREMENT,
    data_hora TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    valor DECIMAL(15,2) NOT NULL,
    observacao VARCHAR(255),
    id_tipo_transacao INT NOT NULL,
    id_conta_origem INT,
    id_conta_destino INT,
    FOREIGN KEY (id_tipo_transacao) REFERENCES TIPO_TRANSACAO(id_tipo_transacao),
    FOREIGN KEY (id_conta_origem) REFERENCES CONTA(id_conta),
    FOREIGN KEY (id_conta_destino) REFERENCES CONTA(id_conta),
    CHECK ((id_conta_origem IS NOT NULL OR id_conta_destino IS NOT NULL))
);

-- 3. Dados iniciais
INSERT INTO TIPO_CONTA (descricao) VALUES ('corrente'), ('poupanca');
INSERT INTO TIPO_TRANSACAO (descricao) VALUES ('deposito'), ('saque'), ('transferencia');
INSERT INTO AGENCIA (codigo_agencia, nome, cidade) VALUES ('0001', 'Agencia Digital', 'Sao Paulo');
